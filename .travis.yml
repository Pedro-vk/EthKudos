sudo: required
language: node_js
node_js:
- '9'
addons:
  chrome: stable
branches:
  only:
  - master
before_install:
- export DISPLAY=:99.0
- sh -e /etc/init.d/xvfb start
- sleep 3
- openssl aes-256-cbc -K $encrypted_ed587a115bcb_key -iv $encrypted_ed587a115bcb_iv
  -in .travisGitHub.enc -out .travisGitHub -d
jobs:
  include:
    # Tests and code quality
    - stage: "Test & code quality"
      script: npm run test:ng
      name: "Angular app testing"
    - script: npm run test:sol
      name: "Smart contracts testing"
    # Code quality
    - script: npm run lint:coveralls
      name: "Linters & Coveralls"
    # Build & Deploy (PR/branches)
    - stage: "Build & Deploy"
      if: branch != master
      name: "Angular app build"
      script: npm run build
    # Build & Deploy (master branch)
    - stage: "Build & Deploy"
      if: branch = master
      name: "Build app, GitHub pages deploy & Cloudflare cleanup"
      script: >
        npm run build
        && npm run gh-pages-travis
        && curl -X DELETE "https://api.cloudflare.com/client/v4/zones/${cloudflare_zone}/purge_cache"
          -H "X-Auth-Email: ${cloudflare_email}"
          -H "X-Auth-Key: ${cloudflare_key}"
          -H "Content-Type: application/json"
          --data '{"purge_everything":true}'
env:
  global:
  - SSH_KEY=".travisGitHub"
  - GIT_NAME="Pedro Guti√©rrez"
  - GIT_EMAIL="pedrogp9_6_93@hotmail.com"
  - SOURCE_DIR="dist"
  - DEPLOY_BRANCH="master"

